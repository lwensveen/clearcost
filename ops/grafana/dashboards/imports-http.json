{
  "title": "Clearcost • HTTP & Imports",
  "timezone": "browser",
  "editable": true,
  "refresh": "30s",
  "schemaVersion": 38,
  "version": 1,
  "panels": [
    {
      "type": "stat",
      "title": "HTTP RPS (5m)",
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 6,
        "h": 4
      },
      "datasource": "${DS_PROMETHEUS}",
      "targets": [
        {
          "expr": "sum(rate(http_server_requests_total[5m]))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "stat",
      "title": "HTTP 5xx / 5m",
      "gridPos": {
        "x": 6,
        "y": 0,
        "w": 6,
        "h": 4
      },
      "datasource": "${DS_PROMETHEUS}",
      "targets": [
        {
          "expr": "sum(increase(http_server_requests_total{status_code=~\"5..\"}[5m]))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "graph",
      "title": "Latency p95 (by route)",
      "gridPos": {
        "x": 0,
        "y": 4,
        "w": 12,
        "h": 8
      },
      "datasource": "${DS_PROMETHEUS}",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(http_server_request_duration_seconds_bucket[5m])) by (le, route))",
          "legendFormat": "{{route}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "table",
      "title": "Imports • Last activity age (min)",
      "gridPos": {
        "x": 0,
        "y": 12,
        "w": 12,
        "h": 7
      },
      "datasource": "${DS_PROMETHEUS}",
      "targets": [
        {
          "expr": "((time() - clearcost_import_last_run_timestamp) / 60)",
          "legendFormat": "{{import_id}}",
          "refId": "A",
          "format": "table"
        }
      ],
      "transformations": [
        {
          "id": "labelsToFields",
          "options": {
            "mode": "columns"
          }
        }
      ]
    },
    {
      "type": "graph",
      "title": "Imports • Rows inserted (24h, by job)",
      "gridPos": {
        "x": 0,
        "y": 19,
        "w": 12,
        "h": 8
      },
      "datasource": "${DS_PROMETHEUS}",
      "targets": [
        {
          "expr": "sum(increase(clearcost_import_rows_inserted_total[24h])) by (job)",
          "legendFormat": "{{job}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "graph",
      "title": "Imports • Errors (24h, by job)",
      "gridPos": {
        "x": 0,
        "y": 27,
        "w": 12,
        "h": 8
      },
      "datasource": "${DS_PROMETHEUS}",
      "targets": [
        {
          "expr": "sum(increase(clearcost_import_errors_total[24h])) by (job)",
          "legendFormat": "{{job}}",
          "refId": "A"
        }
      ]
    }
  ],
  "templating": {
    "list": [
      {
        "type": "datasource",
        "name": "DS_PROMETHEUS",
        "query": "prometheus",
        "hide": 0
      }
    ]
  }
}
