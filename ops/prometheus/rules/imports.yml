groups:
  - name: imports
    rules:
      # Running imports in high-age buckets likely indicate stale locks/heartbeats.
      - alert: ImportRunStuck
        expr: sum(clearcost_imports_running{age_bucket=~"60-120m|120-240m|>240m"}) > 0
        for: 10m
        labels:
          severity: page
        annotations:
          summary: 'Import run appears stuck'
          description: 'At least one import has been in a 60m+ running bucket for 10m.'

      # Nightly FX: no inserted rows in the last 36h.
      - alert: FxDailyMissed
        expr: increase(clearcost_import_rows_inserted_total{job=~"fx:daily|fx:refresh"}[36h]) == 0
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: 'FX daily appears to have missed at least one run'
          description: 'No rows inserted by FX refresh jobs in 36h.'

      # Data freshness thresholds used by release readiness runbook.
      - alert: FxDataStale
        expr: (time() - max(clearcost_import_last_run_timestamp{job=~"fx:daily|fx:refresh"})) > 30 * 60 * 60
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: 'FX data stale (>30h)'
          description: 'Latest FX import run is older than 30 hours.'

      - alert: VatDataStale
        expr: (time() - max(clearcost_import_last_run_timestamp{job="vat:auto"})) > 48 * 60 * 60
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: 'VAT data stale (>48h)'
          description: 'Latest VAT auto import run is older than 48 hours.'

      - alert: EuDutiesDailyStale
        expr: (time() - max(clearcost_import_last_run_timestamp{job="duties:eu-daily"})) > 48 * 60 * 60
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: 'EU daily duties data stale (>48h)'
          description: 'Latest duties:eu-daily run is older than 48 hours.'

      - alert: DeMinimisDataStale
        expr: (time() - max(clearcost_import_last_run_timestamp{job=~"de-minimis:.*"})) > 48 * 60 * 60
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: 'De-minimis data stale (>48h)'
          description: 'Latest de-minimis import run is older than 48 hours.'

      - alert: NoticesDataStale
        expr: (time() - max(clearcost_import_last_run_timestamp{job=~"notices:.*"})) > 48 * 60 * 60
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: 'Notices data stale (>48h)'
          description: 'Latest notices import run is older than 48 hours.'

      - alert: WeeklyHeavyImportsStale
        expr: (time() - max(clearcost_import_last_run_timestamp{job=~"duties:wits.*|hs:.*|surcharges:.*"})) > 8 * 24 * 60 * 60
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: 'Weekly heavy imports stale (>8d)'
          description: 'One or more weekly heavy import families are older than 8 days.'
