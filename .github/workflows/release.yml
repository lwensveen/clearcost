name: Release
on:
  workflow_run:
    workflows: ['Staging Smoke']
    types: [completed]
  workflow_dispatch: {}

jobs:
  release:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
      packages: write

    steps:
      - name: Require recent successful staging smoke (manual runs)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: 'staging-smoke.yml',
              branch: 'main',
              per_page: 20,
            });
            const latestSuccess = runs.data.workflow_runs.find((run) => run.conclusion === 'success');
            if (!latestSuccess) {
              core.setFailed('No successful Staging Smoke run found on main.');
              return;
            }
            const ageMs = Date.now() - new Date(latestSuccess.updated_at).getTime();
            const ageHours = ageMs / (1000 * 60 * 60);
            if (ageHours > 24) {
              core.setFailed(
                `Latest successful Staging Smoke run is older than 24h (${ageHours.toFixed(1)}h).`
              );
              return;
            }
            core.notice(
              `Using recent Staging Smoke evidence: run #${latestSuccess.run_number} (${ageHours.toFixed(1)}h old).`
            );

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node & Bun
        uses: ./.github/actions/setup-node-bun
        with:
          node-version: '22'
          bun-version: '1.3.8'

      - name: Version packages via Changesets
        run: bunx changeset version

      - name: Commit & push
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          changed="$(git diff --name-only)"
          if [ -z "$changed" ]; then
            echo "No versioning changes to commit"
            exit 0
          fi

          unexpected="$(echo "$changed" | grep -Ev '^(\.changeset/|package\.json|bun\.lock|apps/[^/]+/package\.json|packages/[^/]+/package\.json|CHANGELOG\.md|apps/[^/]+/CHANGELOG\.md|packages/[^/]+/CHANGELOG\.md)$' || true)"
          if [ -n "$unexpected" ]; then
            echo "Unexpected files changed by changeset version:"
            echo "$unexpected"
            exit 1
          fi

          while IFS= read -r file; do
            [ -n "$file" ] && git add "$file"
          done <<< "$changed"

          git commit -m "chore(release): version bump and changelogs" || echo "No changes to commit"
          git push
