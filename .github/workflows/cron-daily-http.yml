name: Cron (Daily â€” HTTP)

on:
  schedule:
    - cron: '7 3 * * *' # daily 03:07 UTC
  workflow_dispatch: {}

concurrency:
  group: cron-daily-http
  cancel-in-progress: false

jobs:
  daily:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      API: ${{ secrets.CLEARCOST_API_URL }}
      TASKS_KEY: ${{ secrets.CLEARCOST_TASKS_API_KEY }}
      PRUNE_DAYS: ${{ vars.IMPORTS_PRUNE_DAYS || 90 }}
    steps:
      - name: FX daily (ECB)
        run: |
          curl --fail-with-body --show-error --silent \
            --retry 3 --retry-all-errors \
            -X POST -H "x-api-key: $TASKS_KEY" \
            "${API%/}/internal/cron/fx/daily" | jq .

      - name: VAT (OECD/IMF auto)
        run: |
          curl --fail-with-body --show-error --silent \
            --retry 3 --retry-all-errors \
            -X POST -H "x-api-key: $TASKS_KEY" \
            "${API%/}/internal/cron/import/vat/auto" | jq .

      - name: EU Duties (TARIC â€” daily)
        run: |
          curl --fail-with-body --show-error --silent \
            --retry 3 --retry-all-errors \
            -X POST -H "x-api-key: $TASKS_KEY" \
            "${API%/}/internal/cron/import/duties/eu/daily" | jq .

      - name: JP Duties â€” MFN (Customs)
        run: |
          curl --fail-with-body --show-error --silent \
            --retry 3 --retry-all-errors \
            -X POST -H "x-api-key: $TASKS_KEY" \
            "${API%/}/internal/cron/import/duties/jp-mfn" | jq .

      - name: De Minimis â€” official
        run: |
          curl --fail-with-body --show-error --silent \
            --retry 3 --retry-all-errors \
            -X POST -H "x-api-key: $TASKS_KEY" \
            "${API%/}/internal/cron/de-minimis/import-official" | jq .

      - name: De Minimis â€” Zonos
        run: |
          curl --fail-with-body --show-error --silent \
            --retry 3 --retry-all-errors \
            -X POST -H "x-api-key: $TASKS_KEY" \
            "${API%/}/internal/cron/de-minimis/import-zonos" | jq .

      - name: Prune old imports & provenance
        run: |
          BODY="{\"days\": ${PRUNE_DAYS}}"
          curl --fail-with-body --show-error --silent \
            --retry 3 --retry-all-errors \
            -X POST \
            -H "x-api-key: $TASKS_KEY" \
            -H "content-type: application/json" \
            -d "$BODY" \
            "${API%/}/internal/cron/imports/prune" | jq .

      - name: Slack (success)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            line1="âœ… ${{ github.workflow }} succeeded in ${{ github.repository }} on \`${{ github.ref_name }}\`"
            payload=$(jq -n --arg line1 "$line1" --arg run "$RUN_URL" '{text: ($line1 + "\n" + $run)}')
            curl -fsS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
          fi

      - name: Slack (failure)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            line1="ðŸš¨ ${{ github.workflow }} failed in ${{ github.repository }} on \`${{ github.ref_name }}\`"
            payload=$(jq -n --arg line1 "$line1" --arg run "$RUN_URL" '{text: ($line1 + "\n" + $run)}')
            curl -fsS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
          fi

      - name: Discord (success)
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${DISCORD_WEBHOOK_URL:-}" ]; then
            content="âœ… **${{ github.workflow }}** succeeded in **${{ github.repository }}** on \`${{ github.ref_name }}\`\n${RUN_URL}"
            payload=$(jq -n --arg content "$content" '{content: $content}')
            curl -fsS -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK_URL"
          fi

      - name: Discord (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${DISCORD_WEBHOOK_URL:-}" ]; then
            content="ðŸš¨ **${{ github.workflow }}** failed in **${{ github.repository }}** on \`${{ github.ref_name }}\`\n${RUN_URL}"
            payload=$(jq -n --arg content "$content" '{content: $content}')
            curl -fsS -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK_URL"
          fi
