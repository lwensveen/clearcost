name: Cron (Daily â€” HTTP)

on:
  schedule:
    - cron: '7 3 * * *' # daily 03:07 UTC
  workflow_dispatch: {}

concurrency:
  group: cron-daily-http
  cancel-in-progress: false

jobs:
  daily:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      CLEARCOST_INTERNAL_API_URL: ${{ secrets.CLEARCOST_INTERNAL_API_URL }}
      CLEARCOST_TASKS_API_KEY: ${{ secrets.CLEARCOST_TASKS_API_KEY }}
      INTERNAL_SIGNING_SECRET: ${{ secrets.INTERNAL_SIGNING_SECRET }}
      MY_MFN_OFFICIAL_EXCEL_URL: ${{ secrets.MY_MFN_OFFICIAL_EXCEL_URL || '' }}
      PH_TARIFF_EXCEL_URL: ${{ secrets.PH_TARIFF_EXCEL_URL || '' }}
      UK_REMEDY_MEASURE_TYPES: ${{ vars.UK_REMEDY_MEASURE_TYPES || '552,551,695' }}
      EU_TARIC_REMEDY_TYPES: ${{ vars.EU_TARIC_REMEDY_TYPES || '' }}
      PRUNE_DAYS: ${{ vars.IMPORTS_PRUNE_DAYS || 90 }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.8'

      - name: Validate internal envs
        run: bun run internal-request -- --validate

      - name: FX daily (ECB)
        run: |
          OUT=$(bun run internal-request -- --path /internal/cron/fx/daily --body '{}')
          echo "$OUT" | jq .
          FX_AS_OF=$(echo "$OUT" | jq -r '.fxAsOf // empty')
          if [ -z "$FX_AS_OF" ]; then
            echo "[fx:daily] missing fxAsOf in response"
            exit 1
          fi

      - name: VAT (OECD/IMF auto)
        run: |
          OUT=$(bun run internal-request -- --path /internal/cron/import/vat/auto --body '{}')
          echo "$OUT" | jq .
          ROWS=$(echo "$OUT" | jq -r '([.count,.inserted,.updated] | map(select(type=="number")) | add) // 0')
          if [ "$ROWS" -lt 1 ]; then
            echo "[vat:auto] expected >0 imported rows, got $ROWS"
            exit 1
          fi

      - name: EU Duties (TARIC â€” daily)
        run: |
          bun run internal-request -- --path /internal/cron/import/duties/eu/daily --body '{}' | jq .

      - name: JP Duties â€” MFN (Customs)
        run: |
          bun run internal-request -- --path /internal/cron/import/duties/jp-mfn --body '{}' | jq .

      - name: UK Duties â€” MFN
        run: |
          bun run internal-request -- --path /internal/cron/import/duties/uk-mfn --body '{}' | jq .

      - name: UK Duties â€” FTA
        run: |
          bun run internal-request -- --path /internal/cron/import/duties/uk-fta --body '{}' | jq .

      - name: ID Duties â€” MFN (official)
        run: |
          bun run internal-request -- --path /internal/cron/import/duties/id-mfn --body '{}' | jq .

      - name: US Duties â€” MFN (HTS)
        run: |
          OUT=$(bun run internal-request -- --path /internal/cron/import/duties/us-mfn --body '{}')
          echo "$OUT" | jq .
          ROWS=$(echo "$OUT" | jq -r '([.count,.inserted,.updated] | map(select(type=="number")) | add) // 0')
          if [ "$ROWS" -lt 1 ]; then
            echo "[duties:us-mfn] expected >0 imported rows, got $ROWS"
            exit 1
          fi

      - name: US Duties â€” FTA (HTS)
        run: |
          OUT=$(bun run internal-request -- --path /internal/cron/import/duties/us-preferential --body '{}')
          echo "$OUT" | jq .
          ROWS=$(echo "$OUT" | jq -r '([.count,.inserted,.updated] | map(select(type=="number")) | add) // 0')
          if [ "$ROWS" -lt 1 ]; then
            echo "[duties:us-fta] expected >0 imported rows, got $ROWS"
            exit 1
          fi

      - name: MY Duties â€” MFN official Excel (if configured)
        if: ${{ env.MY_MFN_OFFICIAL_EXCEL_URL != '' }}
        run: |
          BODY=$(jq -n --arg url "$MY_MFN_OFFICIAL_EXCEL_URL" '{url: $url}')
          bun run internal-request -- --path /internal/cron/import/duties/my-mfn/official/excel --body "$BODY" | jq .

      - name: PH Duties â€” MFN official Excel (if configured)
        if: ${{ env.PH_TARIFF_EXCEL_URL != '' }}
        run: |
          BODY=$(jq -n --arg url "$PH_TARIFF_EXCEL_URL" '{url: $url}')
          bun run internal-request -- --path /internal/cron/import/duties/ph-mfn --body "$BODY" | jq .

      - name: UK Surcharges â€” remedies
        run: |
          BODY=$(jq -n --arg s "$UK_REMEDY_MEASURE_TYPES" '{measureTypeIds: ($s | split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length > 0)))}')
          OUT=$(bun run internal-request -- --path /internal/cron/import/surcharges/uk-remedies --body "$BODY")
          echo "$OUT" | jq .
          ROWS=$(echo "$OUT" | jq -r '([.count,.inserted,.updated] | map(select(type=="number")) | add) // 0')
          if [ "$ROWS" -lt 1 ]; then
            echo "[surcharges:uk-remedies] expected >0 imported rows, got $ROWS"
            exit 1
          fi

      - name: EU Surcharges â€” remedies (when configured)
        if: ${{ env.EU_TARIC_REMEDY_TYPES != '' }}
        run: |
          BODY=$(jq -n --arg s "$EU_TARIC_REMEDY_TYPES" '{measureTypeIds: ($s | split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length > 0)))}')
          OUT=$(bun run internal-request -- --path /internal/cron/import/surcharges/eu-remedies --body "$BODY")
          echo "$OUT" | jq .
          ROWS=$(echo "$OUT" | jq -r '([.count,.inserted,.updated] | map(select(type=="number")) | add) // 0')
          if [ "$ROWS" -lt 1 ]; then
            echo "[surcharges:eu-remedies] expected >0 imported rows, got $ROWS"
            exit 1
          fi

      - name: US Surcharges â€” all
        run: |
          OUT=$(bun run internal-request -- --path /internal/cron/import/surcharges/us-all --body '{}')
          echo "$OUT" | jq .
          ROWS=$(echo "$OUT" | jq -r '([.count,.inserted,.updated] | map(select(type=="number")) | add) // 0')
          if [ "$ROWS" -lt 1 ]; then
            echo "[surcharges:us-all] expected >0 imported rows, got $ROWS"
            exit 1
          fi

      - name: De Minimis â€” official
        run: |
          OUT=$(bun run internal-request -- --path /internal/cron/de-minimis/import-official --body '{}')
          echo "$OUT" | jq .
          ROWS=$(echo "$OUT" | jq -r '([.count,.inserted,.updated] | map(select(type=="number")) | add) // 0')
          if [ "$ROWS" -lt 1 ]; then
            echo "[de-minimis:import-official] expected >0 imported rows, got $ROWS"
            exit 1
          fi

      - name: De Minimis â€” Zonos
        run: |
          OUT=$(bun run internal-request -- --path /internal/cron/de-minimis/import-zonos --body '{}')
          echo "$OUT" | jq .
          ROWS=$(echo "$OUT" | jq -r '([.count,.inserted,.updated] | map(select(type=="number")) | add) // 0')
          if [ "$ROWS" -lt 1 ]; then
            echo "[de-minimis:import-zonos] expected >0 imported rows, got $ROWS"
            exit 1
          fi

      - name: Notices â€” CN (MOF)
        run: |
          bun run internal-request -- --path /internal/cron/notices/cn/mof --body '{}' | jq .

      - name: Notices â€” CN (GACC)
        run: |
          bun run internal-request -- --path /internal/cron/notices/cn/gacc --body '{}' | jq .

      - name: Notices â€” CN (MOFCOM)
        run: |
          bun run internal-request -- --path /internal/cron/notices/cn/mofcom --body '{}' | jq .

      - name: Prune old imports & provenance
        run: |
          BODY="{\"days\": ${PRUNE_DAYS}}"
          bun run internal-request -- --path /internal/cron/imports/prune --body "$BODY" | jq .

      - name: Slack (success)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            line1="âœ… ${{ github.workflow }} succeeded in ${{ github.repository }} on \`${{ github.ref_name }}\`"
            payload=$(jq -n --arg line1 "$line1" --arg run "$RUN_URL" '{text: ($line1 + "\n" + $run)}')
            curl -fsS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
          fi

      - name: Slack (failure)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            line1="ðŸš¨ ${{ github.workflow }} failed in ${{ github.repository }} on \`${{ github.ref_name }}\`"
            payload=$(jq -n --arg line1 "$line1" --arg run "$RUN_URL" '{text: ($line1 + "\n" + $run)}')
            curl -fsS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
          fi

      - name: Discord (success)
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${DISCORD_WEBHOOK_URL:-}" ]; then
            content="âœ… **${{ github.workflow }}** succeeded in **${{ github.repository }}** on \`${{ github.ref_name }}\`\n${RUN_URL}"
            payload=$(jq -n --arg content "$content" '{content: $content}')
            curl -fsS -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK_URL"
          fi

      - name: Discord (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${DISCORD_WEBHOOK_URL:-}" ]; then
            content="ðŸš¨ **${{ github.workflow }}** failed in **${{ github.repository }}** on \`${{ github.ref_name }}\`\n${RUN_URL}"
            payload=$(jq -n --arg content "$content" '{content: $content}')
            curl -fsS -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK_URL"
          fi
