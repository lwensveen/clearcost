name: Cron (Weekly â€” CLI / Direct DB)

on:
  schedule:
    - cron: '13 4 * * 0' # Sundays 04:13 UTC
  workflow_dispatch: {}

concurrency:
  group: cron-weekly-cli
  cancel-in-progress: false

jobs:
  heavy:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      NODE_ENV: production
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DATA_REMOTE_BASE: ${{ secrets.DATA_REMOTE_BASE || '' }}
      AHTN_SOURCE_URL: ${{ secrets.AHTN_SOURCE_URL || '' }}
      ENABLE_WITS_BACKFILL: ${{ vars.ENABLE_WITS_BACKFILL || 'false' }}
      TZ: UTC
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node & Bun (with cache)
        uses: ./.github/actions/setup-node-bun
        with:
          node-version: '22'
          bun-version: '1.3.8'

      # ------------ HS ------------
      - name: HS â€” EU HS6 titles (TARIC)
        working-directory: apps/api
        run: |
          OUT=$(bun run src/lib/run-cron.ts import:hs:eu-hs6 2>&1)
          echo "$OUT"
          COUNT=$(echo "$OUT" | sed -nE 's/.*count:\s*([0-9]+).*/\1/p' | tail -n1)
          if [ -z "$COUNT" ] || [ "$COUNT" -lt 1 ]; then
            echo "[hs:eu-hs6] expected >0 rows, got ${COUNT:-missing}"
            exit 1
          fi

      - name: HS â€” US HTS10 aliases
        working-directory: apps/api
        run: bun run src/lib/run-cron.ts import:hs:us-hts10

      - name: HS â€” UK 10-digit aliases
        working-directory: apps/api
        run: bun run src/lib/run-cron.ts import:hs:uk10

      - name: HS â€” AHTN8 (if URL provided)
        if: ${{ env.AHTN_SOURCE_URL != '' }}
        working-directory: apps/api
        run: bun run src/lib/run-cron.ts import:hs:ahtn --url "$AHTN_SOURCE_URL"

      # ---------- Duties (WITS) ----------
      - name: Duties â€” WITS (ASEAN)
        if: ${{ env.ENABLE_WITS_BACKFILL == 'true' }}
        working-directory: apps/api
        run: |
          OUT=$(bun run src/lib/run-cron.ts import:duties:wits \
            --dests SG,MY,TH,ID,PH,VN,BN,KH,LA,MM \
            --partners SG,MY,TH,ID,PH,VN,BN,KH,LA,MM \
            --backfillYears 1 \
            --concurrency 4 2>&1)
          echo "$OUT"
          FETCHED=$(echo "$OUT" | sed -nE 's/.*fetchedRows:\s*([0-9]+).*/\1/p' | tail -n1)
          if [ -z "$FETCHED" ] || [ "$FETCHED" -lt 1 ]; then
            echo "[duties:wits:asean] expected >0 fetchedRows, got ${FETCHED:-missing}"
            exit 1
          fi

      - name: Duties â€” WITS (Japan + partners)
        if: ${{ env.ENABLE_WITS_BACKFILL == 'true' }}
        working-directory: apps/api
        run: |
          OUT=$(bun run src/lib/run-cron.ts import:duties:wits \
            --dests JP \
            --partners CN,KR,AU,NZ,TH,MY,ID,PH,VN,LA,KH,BN,SG,CA,MX,EU,GB,US \
            --backfillYears 1 \
            --concurrency 3 2>&1)
          echo "$OUT"
          FETCHED=$(echo "$OUT" | sed -nE 's/.*fetchedRows:\s*([0-9]+).*/\1/p' | tail -n1)
          if [ -z "$FETCHED" ] || [ "$FETCHED" -lt 1 ]; then
            echo "[duties:wits:japan] expected >0 fetchedRows, got ${FETCHED:-missing}"
            exit 1
          fi

      - name: Duties â€” WITS (China + partners)
        if: ${{ env.ENABLE_WITS_BACKFILL == 'true' }}
        working-directory: apps/api
        run: |
          OUT=$(bun run src/lib/run-cron.ts import:duties:wits \
            --dests CN \
            --partners EU,US,GB,JP,KR,AU,NZ,CA,MX,CL,PE,PK,CH,NO,IS,LI,SG,MY,TH,ID,PH,VN,LA,KH,BN \
            --backfillYears 1 \
            --concurrency 3 2>&1)
          echo "$OUT"
          FETCHED=$(echo "$OUT" | sed -nE 's/.*fetchedRows:\s*([0-9]+).*/\1/p' | tail -n1)
          if [ -z "$FETCHED" ] || [ "$FETCHED" -lt 1 ]; then
            echo "[duties:wits:china] expected >0 fetchedRows, got ${FETCHED:-missing}"
            exit 1
          fi

      - name: CN â€” MFN from official PDF (Tabula)
        if: ${{ env.CN_MFN_PDF_URL != '' }}
        env:
          TABULA_JAR_URL: ${{ vars.TABULA_JAR_URL || 'https://github.com/tabulapdf/tabula-java/releases/download/v1.0.5/tabula-1.0.5-jar-with-dependencies.jar' }}
          CN_MFN_PDF_URL: ${{ secrets.CN_MFN_PDF_URL }}
        working-directory: apps/api
        run: |
          sudo apt-get update && sudo apt-get install -y default-jre
          curl -L "$TABULA_JAR_URL" -o tabula.jar
          export TABULA_JAR="$PWD/tabula.jar"
          bun run src/lib/run-cron.ts import:duties:cn-mfn-pdf --url="$CN_MFN_PDF_URL" --mode=auto

      # US duties + US surcharges run daily in cron-daily-http.yml (fail-fast).
      # Keep weekly focused on heavier backfill/import jobs to avoid duplicate loads.

      - name: Freight â€” cards JSON (if remote base configured)
        if: ${{ env.DATA_REMOTE_BASE != '' }}
        working-directory: apps/api
        run: |
          OUT=$(bun run src/lib/run-cron.ts import:freight "$DATA_REMOTE_BASE/freight/freight-cards.json" 2>&1)
          echo "$OUT"
          COUNT=$(echo "$OUT" | sed -nE 's/.*count:\s*([0-9]+).*/\1/p' | tail -n1)
          if [ -z "$COUNT" ] || [ "$COUNT" -lt 1 ]; then
            echo "[freight:json] expected >0 rows, got ${COUNT:-missing}"
            exit 1
          fi

      - name: Slack (success)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            line1="âœ… ${{ github.workflow }} succeeded in ${{ github.repository }} on \`${{ github.ref_name }}\`"
            payload=$(jq -n --arg line1 "$line1" --arg run "$RUN_URL" '{text: ($line1 + "\n" + $run)}')
            curl -fsS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
          fi

      - name: Slack (failure)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            line1="ðŸš¨ ${{ github.workflow }} failed in ${{ github.repository }} on \`${{ github.ref_name }}\`"
            payload=$(jq -n --arg line1 "$line1" --arg run "$RUN_URL" '{text: ($line1 + "\n" + $run)}')
            curl -fsS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
          fi

      - name: Discord (success)
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${DISCORD_WEBHOOK_URL:-}" ]; then
            content="âœ… **${{ github.workflow }}** succeeded in **${{ github.repository }}** on \`${{ github.ref_name }}\`\n${RUN_URL}"
            payload=$(jq -n --arg content "$content" '{content: $content}')
            curl -fsS -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK_URL"
          fi

      - name: Discord (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -n "${DISCORD_WEBHOOK_URL:-}" ]; then
            content="ðŸš¨ **${{ github.workflow }}** failed in **${{ github.repository }}** on \`${{ github.ref_name }}\`\n${RUN_URL}"
            payload=$(jq -n --arg content "$content" '{content: $content}')
            curl -fsS -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK_URL"
          fi
